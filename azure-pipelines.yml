trigger:
  - main

variables:
  - group: nextjob-secrets  # Importa vari√°veis secretas do Variable Group
  - name: AZURE_SUBSCRIPTION
    value: 'AzureNextJob'
  - name: RESOURCE_GROUP
    value: 'rg-nextjob-rm555197'
  - name: LOCATION
    value: 'eastus'
  - name: ACR_NAME
    value: 'acrnextjobrm555197'
  - name: ACR_LOGIN_SERVER
    value: 'acrnextjobrm555197.azurecr.io'
  - name: IMAGE_NAME
    value: 'appnextjob'
  - name: IMAGE_TAG
    value: 'latest'
  - name: APP_NAME
    value: 'aci-app-nextjob-rm555197'
  - name: DB_USER
    value: 'nextjob'
  - name: DB_NAME
    value: 'nextjob'
  - name: RM
    value: '555197'

stages:
# ===============================================================
# 1Ô∏è‚É£ - BUILD & TEST (CI)
# ===============================================================
  - stage: Build
    displayName: "Build & Test Application"
    jobs:
      - job: BuildApp
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: self

          # Cache do Gradle
          - task: Cache@2
            displayName: "Cache Gradle dependencies"
            inputs:
              key: 'gradle | "$(Agent.OS)" | **/*.gradle*'
              path: $(Pipeline.Workspace)/.gradle
              restoreKeys: |
                gradle | "$(Agent.OS)"
            continueOnError: true

          # Build e Testes
          - task: Gradle@4
            displayName: "Run build and tests"
            inputs:
              gradleWrapperFile: 'gradlew'
              tasks: 'clean build'
              options: '--build-cache -Dspring.profiles.active=test'
              publishJUnitResults: true
              testResultsFiles: '**/TEST-*.xml'

          # Publicar artefato do JAR
          - task: CopyFiles@2
            displayName: "Copy Build Artifact"
            inputs:
              SourceFolder: '$(System.DefaultWorkingDirectory)'
              Contents: '**/build/libs/*.jar'
              TargetFolder: '$(Build.ArtifactStagingDirectory)'

          - publish: '$(Build.ArtifactStagingDirectory)'
            artifact: 'nextjobApp'

# ===============================================================
# 2Ô∏è‚É£ - BUILD DOCKER IMAGE (Publica√ß√£o no ACR)
# ===============================================================
  - stage: PublishImage
    displayName: "Build & Push Docker Image"
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: DockerBuild
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: self

          - task: Docker@2
            displayName: "Login to ACR"
            inputs:
              command: login
              containerRegistry: 'nextjobservice'

          - task: Docker@2
            displayName: "Build and Push Image"
            inputs:
              command: buildAndPush
              repository: '$(IMAGE_NAME)'
              tags: |
                $(IMAGE_TAG)
                $(Build.BuildId)
              dockerfile: '**/Dockerfile'

# ===============================================================
# 3Ô∏è‚É£ - DEPLOY (CD AUTOM√ÅTICO)
# ===============================================================
  - stage: Deploy
    displayName: "Deploy to Azure Container Instances"
    dependsOn: PublishImage
    condition: succeeded()
    jobs:
      - job: DeployACI
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: AzureCLI@2
            displayName: "Deploy to ACI"
            inputs:
              azureSubscription: '$(AZURE_SUBSCRIPTION)'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -e

                echo "Starting deploy to Azure Container Instance..."

                APP_IMAGE="$(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(IMAGE_TAG)"
                APP_CONTAINER_NAME="$(APP_NAME)"
                APP_DNS_LABEL="$(APP_NAME)"

                # Remover container anterior se existir
                az container delete --resource-group $(RESOURCE_GROUP) --name $APP_CONTAINER_NAME --yes || true
                sleep 10

                # Criar container
                az container create \
                  --resource-group $(RESOURCE_GROUP) \
                  --name $APP_CONTAINER_NAME \
                  --image $APP_IMAGE \
                  --cpu 1 --memory 1.5 \
                  --registry-login-server $(ACR_LOGIN_SERVER) \
                  --registry-username $(ACR_USERNAME) \
                  --registry-password $(ACR_PASSWORD) \
                  --environment-variables \
                    DATABASE_URL="$(SPRING_DATASOURCE_URL)" \
                    DATABASE_USERNAME="$(DB_USER)" \
                    DATABASE_PASSWORD="$(DB_PASSWORD)" \
                    SPRING_JPA_HIBERNATE_DDL_AUTO=validate \
                    SPRING_PROFILES_ACTIVE=prod \
                    GITHUB_CLIENT_ID="$(GITHUB_CLIENT_ID)" \
                    GITHUB_CLIENT_SECRET="$(GITHUB_CLIENT_SECRET)" \
                  --ports 8080 \
                  --os-type Linux \
                  --dns-name-label $APP_DNS_LABEL \
                  --location $(LOCATION) \
                  --restart-policy always

                echo "‚úÖ Deploy complete! Access your app at:"
                echo "üëâ http://$APP_DNS_LABEL.$(LOCATION).azurecontainer.io:8080"
