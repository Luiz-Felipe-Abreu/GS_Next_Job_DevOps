trigger:
  - main

variables:
  - group: nextjob-secrets  # Importa vari√°veis secretas do Variable Group
  - name: AZURE_SUBSCRIPTION
    value: 'AzureNextJob'
  - name: RESOURCE_GROUP
    value: 'rg-nextjob-rm555197'
  - name: LOCATION
    value: 'eastus'
  - name: ACR_NAME
    value: 'acrnextjobrm555197'
  - name: ACR_LOGIN_SERVER
    value: 'acrnextjobrm555197.azurecr.io'
  - name: IMAGE_NAME
    value: 'appnextjob'
  - name: IMAGE_TAG
    value: 'latest'
  - name: APP_NAME
    value: 'aci-app-nextjob-rm555197'
  - name: DB_CONTAINER_NAME
    value: 'aci-postgres-nextjob-rm555197'
  - name: DB_IMAGE
    value: 'acrnextjobrm555197.azurecr.io/postgres:14'
  - name: DB_USER
    value: 'nextjob'
  - name: DB_NAME
    value: 'nextjob'
  - name: DB_PASSWORD
    value: 'nextjob'
  - name: RM
    value: '555197'

stages:

# ===============================================================
# 1Ô∏è‚É£ - BUILD & TEST (CI)
# ===============================================================
  - stage: Build
    displayName: "Build & Test Application"
    jobs:
      - job: BuildApp
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: self

          - task: Cache@2
            displayName: "Cache Gradle dependencies"
            inputs:
              key: 'gradle | "$(Agent.OS)" | **/*.gradle*'
              path: $(Pipeline.Workspace)/.gradle
              restoreKeys: |
                gradle | "$(Agent.OS)"
            continueOnError: true

          - task: Gradle@4
            displayName: "Run build and tests"
            inputs:
              gradleWrapperFile: 'gradlew'
              tasks: 'clean build'
              options: '--build-cache -Dspring.profiles.active=test'
              publishJUnitResults: true
              testResultsFiles: '**/TEST-*.xml'

          - task: CopyFiles@2
            displayName: "Copy Build Artifact"
            inputs:
              SourceFolder: '$(System.DefaultWorkingDirectory)'
              Contents: '**/build/libs/*.jar'
              TargetFolder: '$(Build.ArtifactStagingDirectory)'

          - publish: '$(Build.ArtifactStagingDirectory)'
            artifact: 'nextjobApp'

# ===============================================================
# 2Ô∏è‚É£ - BUILD DOCKER IMAGE (Publica√ß√£o no ACR)
# ===============================================================
  - stage: PublishImage
    displayName: "Build & Push Docker Image"
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: DockerBuild
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: self

          - task: Docker@2
            displayName: "Login to ACR"
            inputs:
              command: login
              containerRegistry: 'nextjobservice'

          - task: Docker@2
            displayName: "Build and Push Image"
            inputs:
              command: buildAndPush
              repository: '$(IMAGE_NAME)'
              tags: |
                $(IMAGE_TAG)
                $(Build.BuildId)
              dockerfile: '**/Dockerfile'

# ===============================================================
# 3Ô∏è‚É£ - DEPLOY DO APP + POSTGRES
# ===============================================================
  - stage: Deploy
    displayName: "Deploy App + Postgres to ACI"
    dependsOn: PublishImage
    condition: succeeded()
    jobs:
      - job: DeployACI
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: AzureCLI@2
            displayName: "Deploy Postgres + App"
            inputs:
              azureSubscription: '$(AZURE_SUBSCRIPTION)'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -e

                echo "=============================="
                echo " Deploying PostgreSQL Container"
                echo "=============================="

                # Remover container antigo
                az container delete \
                  --resource-group $(RESOURCE_GROUP) \
                  --name $(DB_CONTAINER_NAME) \
                  --yes || true

                sleep 5

                # Criar container do Postgres
                az container create \
                  --resource-group $(RESOURCE_GROUP) \
                  --name $(DB_CONTAINER_NAME) \
                  --image $(DB_IMAGE) \
                  --cpu 2 --memory 4 \
                  --registry-login-server $(ACR_LOGIN_SERVER) \
                  --registry-username $(ACR_USERNAME) \
                  --registry-password $(ACR_PASSWORD) \
                  --ports 5432 \
                  --environment-variables \
                    POSTGRES_USER=$(DB_USER) \
                    POSTGRES_PASSWORD=$(DB_PASSWORD) \
                    POSTGRES_DB=$(DB_NAME) \
                  --os-type Linux \
                  --restart-policy always

                echo "Postgres deployed successfully!"

                echo "=============================="
                echo " Deploying Application Container"
                echo "=============================="

                APP_IMAGE="$(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(IMAGE_TAG)"

                # Remover app antigo
                az container delete \
                  --resource-group $(RESOURCE_GROUP) \
                  --name $(APP_NAME) \
                  --yes || true

                sleep 8

                # Criar app
                az container create \
                  --resource-group $(RESOURCE_GROUP) \
                  --name $(APP_NAME) \
                  --image $APP_IMAGE \
                  --cpu 1 --memory 1.5 \
                  --registry-login-server $(ACR_LOGIN_SERVER) \
                  --registry-username $(ACR_USERNAME) \
                  --registry-password $(ACR_PASSWORD) \
                  --environment-variables \
                    SPRING_PROFILES_ACTIVE=prod \
                    SPRING_DATASOURCE_URL="jdbc:postgresql://$(DB_CONTAINER_NAME):5432/$(DB_NAME)" \
                    SPRING_DATASOURCE_USERNAME=$(DB_USER) \
                    SPRING_DATASOURCE_PASSWORD=$(DB_PASSWORD) \
                  --ports 8080 \
                  --dns-name-label $(APP_NAME) \
                  --location $(LOCATION) \
                  --os-type Linux \
                  --restart-policy always

                echo "====================================="
                echo " Deploy Complete!"
                echo " App dispon√≠vel em:"
                echo " üëâ http://$(APP_NAME).$(LOCATION).azurecontainer.io:8080"
                echo "====================================="
