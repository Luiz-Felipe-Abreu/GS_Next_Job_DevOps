# Dispara a pipeline quando houver commits na branch main
trigger:
  - main

# Configura√ß√£o das vari√°veis de ambiente globais usadas no pipeline
variables:
  GRADLE_USER_HOME: $(Pipeline.Workspace)/.gradle
  AZURE_LOCATION: eastus
  AZURE_SUBSCRIPTION_ID: 0d4c88e7-0651-4c08-98ee-91f417a4f71c
  RESOURCE_GROUP: rg-nextjob
  ACR_NAME: acrnextjob
  ACR_LOGIN_SERVER: acrnextjob.azurecr.io
  IMAGE_NAME: appnextjob
  IMAGE_TAG: latest
  RM: "555197"
  azureSubscription: AzureNextJob
  DB_NAME: nextjob
  DB_USER: nextjob

# Defini√ß√£o dos est√°gios (Build ‚Üí Deploy)
stages:

  # Est√°gio CI: compila o projeto e gera artefatos
  - stage: Build
    displayName: CI (build & tests)
    jobs:

      # Job respons√°vel por compilar o c√≥digo Java com Gradle
      - job: gradleBuild
        pool:
          vmImage: ubuntu-latest

        steps:
          # Configura√ß√£o de cache do Gradle para acelerar builds futuros
          - task: Cache@2
            inputs:
              key: 'gradle | "$(Agent.OS)" | **/*.gradle*'
              restoreKeys: |
                gradle | "$(Agent.OS)"
                gradle
              path: $(GRADLE_USER_HOME)
            displayName: Configure gradle caching

          # Executa o build da aplica√ß√£o usando o Gradle Wrapper
          - task: Gradle@4
            inputs:
              gradleWrapperFile: "gradlew"
              tasks: "build"
              options: "--build-cache -Dspring.profiles.active=dev -x test"
              publishJUnitResults: false
              javaHomeOption: "JDKVersion"
              jdkVersionOption: "1.21"
              sonarQubeRunAnalysis: false

          # Finaliza processos pendentes do Gradle
          - script: ./gradlew --stop
            displayName: Gradlew stop

          # Copia o JAR gerado para a pasta de artefatos
          - task: CopyFiles@2
            displayName: "Copy Files to artifact staging directory"
            inputs:
              SourceFolder: "$(System.DefaultWorkingDirectory)"
              Contents: "**/build/libs/*SNAPSHOT.jar"
              TargetFolder: $(Build.ArtifactStagingDirectory)

          # Publica os artefatos para serem usados no pr√≥ximo est√°gio
          - publish: $(Build.ArtifactStagingDirectory)
            artifact: nextjobApp

      # Job respons√°vel por montar e subir a imagem Docker para o ACR
      - job: BuildAndPushImage
        displayName: Build and push docker image
        pool:
          vmImage: ubuntu-latest
        dependsOn: gradleBuild
        condition: succeeded()

        steps:
          # Login no Azure e build/push da imagem para o ACR
          - task: AzureCLI@2
            displayName: 'Build and Push Docker Image'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: bash
              scriptLocation: inlineScript
              addSpnToEnvironment: true
              inlineScript: |
                set -euo pipefail

                echo "Logging into ACR..."
                az acr login --name $(ACR_NAME)

                echo "Building Docker image..."
                docker build -t $(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(IMAGE_TAG) \
                              -t $(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(Build.BuildId) \
                              -f Dockerfile .

                echo "Pushing images to ACR..."
                docker push $(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(IMAGE_TAG)
                docker push $(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(Build.BuildId)

                echo "‚úÖ Images pushed successfully!"

  # Est√°gio CD: realiza o deploy da imagem Docker no Azure Container Instances
  - stage: Deploy_ACI
    displayName: CD - Deploy to Azure Container Instances
    dependsOn: Build
    condition: succeeded()
    jobs:

      # Job de deploy da aplica√ß√£o no ACI
      - job: Deploy
        displayName: Deploy App to ACI
        pool:
          vmImage: 'ubuntu-latest'

        steps:
          # N√£o baixa o c√≥digo do reposit√≥rio (n√£o √© necess√°rio nesta etapa)
          - checkout: none

          # Script de deploy usando Azure CLI
          - task: AzureCLI@2
            displayName: 'Deploy Application to ACI'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: bash
              scriptLocation: inlineScript
              addSpnToEnvironment: true
              inlineScript: |
                set -euo pipefail

                echo "Available subscriptions:"
                az account list --output table

                echo "Setting Azure subscription..."
                az account set --subscription "$(AZURE_SUBSCRIPTION_ID)" || {
                  echo "ERROR: Cannot set subscription $(AZURE_SUBSCRIPTION_ID)"
                  exit 1
                }

                echo "Active subscription:"
                az account show

                echo "Getting ACR credentials..."
                ACR_USERNAME=$(az acr credential show --name "$(ACR_NAME)" --query username -o tsv)
                ACR_PASSWORD=$(az acr credential show --name "$(ACR_NAME)" --query "passwords[0].value" -o tsv)

                APP_CONTAINER_NAME="aci-app-nextjob-rm$(RM)"
                APP_DNS_LABEL="aci-app-nextjob-rm$(RM)"

                echo "Cleaning up previous container if it exists..."
                az container delete --resource-group "$(RESOURCE_GROUP)" --name "$APP_CONTAINER_NAME" --yes 2>/dev/null || true
                sleep 15

                APP_IMAGE="$(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(IMAGE_TAG)"

                echo "Deploying application container: $APP_CONTAINER_NAME"
                az container create \
                  --resource-group "$(RESOURCE_GROUP)" \
                  --name "$APP_CONTAINER_NAME" \
                  --image "$APP_IMAGE" \
                  --cpu 1 --memory 1.5 \
                  --registry-login-server "$(ACR_LOGIN_SERVER)" \
                  --registry-username "$ACR_USERNAME" \
                  --registry-password "$ACR_PASSWORD" \
                  --environment-variables \
                    SPRING_DATASOURCE_URL="$(SPRING_DATASOURCE_URL)" \
                    SPRING_DATASOURCE_USERNAME="$(SPRING_DATASOURCE_USERNAME)" \
                    SPRING_JPA_HIBERNATE_DDL_AUTO=validate \
                    SPRING_FLYWAY_ENABLED=true \
                    SPRING_FLYWAY_BASELINE_ON_MIGRATE=true \
                    GROQ_API_KEY="$(GROQ_API_KEY)" \
                    GROQ_API_URL="https://api.groq.com/openai/v1/chat/completions" \
                    GROQ_MODEL="llama-3.3-70b-versatile" \
                    GITHUB_CLIENT_ID="$(GITHUB_CLIENT_ID)" \
                    GITHUB_CLIENT_SECRET="$(GITHUB_CLIENT_SECRET)" \
                  --secure-environment-variables \
                    SPRING_DATASOURCE_PASSWORD="$(SPRING_DATASOURCE_PASSWORD)" \
                  --ports 8080 \
                  --ip-address Public \
                  --os-type Linux \
                  --dns-name-label "$APP_DNS_LABEL" \
                  --location "$(AZURE_LOCATION)" \
                  --restart-policy Always

                if [ $? -eq 0 ]; then
                  echo "Waiting for container to start..."
                  sleep 20

                  CONTAINER_STATE=$(az container show \
                    --resource-group "$(RESOURCE_GROUP)" \
                    --name "$APP_CONTAINER_NAME" \
                    --query "containers[0].instanceView.currentState.state" \
                    -o tsv)

                  APP_FQDN=$(az container show \
                    --resource-group "$(RESOURCE_GROUP)" \
                    --name "$APP_CONTAINER_NAME" \
                    --query ipAddress.fqdn \
                    -o tsv)

                  APP_URL="http://${APP_FQDN}:8080"

                  echo ""
                  echo "‚úÖ ============================================"
                  echo "‚úÖ Application deployed successfully!"
                  echo "=============================================="
                  echo "üåê Application URL: $APP_URL"
                  echo "üîç Health Check: $APP_URL/actuator/health"
                  echo ""
                else
                  echo "‚ùå Failed to deploy container"
                  exit 1
                fi
